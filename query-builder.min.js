!function(a){"use strict";var b=["string","integer","double","date","time","datetime"],c=["text","radio","checkbox","select"],d=function(b,c){var e=this;this.$el=b,this.settings=a.extend(!0,{},d.DEFAULTS,c),this.filters=this.settings.filters,this.lang=this.settings.lang,this.operators=this.settings.operators,this.status={group_id:0,rule_id:0,generatedId:!1},this.$el.attr("id")||(this.$el.attr("id","qb_"+Math.floor(99999*Math.random())),this.status.generatedId=!0),this.$el_id=this.$el.attr("id"),(!this.filters||this.filters.length<1)&&a.error("Missing filters list"),this.checkFilters(),this.$el.on("change.queryBuilder",".rules-group-header input[name$=_cond]",function(){var b=a(this);b.is(":checked")&&(b.parent().addClass("active"),b.parent().siblings().removeClass("active"))}),this.$el.on("change.queryBuilder",".rule-filter-container select[name$=_filter]",function(){var b=a(this),c=b.closest("li"),d=e.getFilterById(e.getRuleFilter(c));e.createRuleOperators(c,b.val()),"page_filter"==d.plugin&&e.createPageDropDown(c,b.val()),e.createRuleInput(c,b.val())}),this.$el.on("change.queryBuilder",".rule-operator-container select[name$=_operator]",function(){var b=a(this),c=b.closest("li");e.updateRuleOperator(c,b.val())}),this.$el.on("change.queryBuilder",".rule-page-container select",function(){var b=a(this),c=b.closest("li"),d=e.getFilterById(e.getRuleFilter(c));null!=b.val()&&e.filterPageAnswers(c,d,b.val())}),this.$el.on("click.queryBuilder","[data-add=rule]",function(){var b=a(this),c=b.closest("dl").find(">dd>ul");e.addRule(c)}),this.$el.on("click.queryBuilder","[data-add=group]",function(){var b=a(this),c=b.closest("dl").find(">dd>ul");e.addGroup(c)}),this.$el.on("click.queryBuilder","[data-delete=rule]",function(){var b=a(this),c=b.closest("li");c.remove()}),this.$el.on("click.queryBuilder","[data-delete=group]",function(){var b=a(this),c=b.closest("dl");c.remove()}),this.$el.addClass("query-builder"),this.addGroup(this.$el)};d.DEFAULTS={onValidationError:null,onAfterAddGroup:null,onAfterAddRule:null,filters:[],lang:{add_rule:"Add rule",add_group:"Add group",delete_rule:"Delete",delete_group:"Delete",and_condition:"AND",or_condition:"OR",filter_select_placeholder:"------",operator_equal:"equal",operator_not_equal:"not equal",operator_in:"in",operator_not_in:"not in",operator_less:"less",operator_less_or_equal:"less or equal",operator_greater:"greater",operator_greater_or_equal:"greater or equal",operator_begins_with:"begins with",operator_not_begins_with:"doesn't begin with",operator_contains:"contains",operator_not_contains:"doesn't contain",operator_ends_with:"ends with",operator_not_ends_with:"doesn't end with",operator_is_empty:"is empty",operator_is_not_empty:"is not empty",operator_is_null:"is null",operator_is_not_null:"is not null"},operators:[{type:"equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"not_equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"in",accept_values:!0,apply_to:["string","number","datetime"]},{type:"not_in",accept_values:!0,apply_to:["string","number","datetime"]},{type:"less",accept_values:!0,apply_to:["number","datetime"]},{type:"less_or_equal",accept_values:!0,apply_to:["number","datetime"]},{type:"greater",accept_values:!0,apply_to:["number","datetime"]},{type:"greater_or_equal",accept_values:!0,apply_to:["number","datetime"]},{type:"begins_with",accept_values:!0,apply_to:["string"]},{type:"not_begins_with",accept_values:!0,apply_to:["string"]},{type:"contains",accept_values:!0,apply_to:["string"]},{type:"not_contains",accept_values:!0,apply_to:["string"]},{type:"ends_with",accept_values:!0,apply_to:["string"]},{type:"not_ends_with",accept_values:!0,apply_to:["string"]},{type:"is_empty",accept_values:!1,apply_to:["string"]},{type:"is_not_empty",accept_values:!1,apply_to:["string"]},{type:"is_null",accept_values:!1,apply_to:["string","number","datetime"]},{type:"is_not_null",accept_values:!1,apply_to:["string","number","datetime"]}]},window.QueryBuilder={setDefaults:function(b){a.extend(!0,d.DEFAULTS,b)}},d.prototype.destroy=function(){this.status.generatedId&&this.$el.removeAttr("id"),this.$el.empty().off("click.queryBuilder change.queryBuilder").removeClass("query-builder").removeData("queryBuilder")},d.prototype.reset=function(){this.status.group_id=1,this.status.rule_id=0,this.addRule(this.$el.find(">dl>dd>ul").empty())},d.prototype.clear=function(){this.status.group_id=0,this.status.rule_id=0,this.$el.empty()},d.prototype.getRules=function(){this.markRuleAsError(this.$el.find("li"),!1);var b=this.$el.find(">dl"),c=this;return function b(d){var e={},f=d.find(">dd>ul>*");e.condition=d.find(">dt input[name$=_cond]:checked").val(),e.rules=[];for(var g=0,h=f.length;g<h;g++){var i=f.eq(g);if(i.hasClass("rule-container")){var j=c.getRuleFilter(i);if("-1"==j)continue;var k=c.getFilterById(j),l=c.getOperator(c.getRuleOperator(i)),m=null;if(l.accept_values){m=c.getRuleValue(i,k);var n=c.validateValue(m,k);if(n!==!0)return c.markRuleAsError(i,!0),c.triggerValidationError(n,k,l,m,i),{};k.valueParser&&(m=k.valueParser.call(this,m,k,l))}var o={id:k.id,field:k.field,type:k.type,input:k.input,operator:l.type,value:m};e.rules.push(o)}else{var o=b(i);if(a.isEmptyObject(o))return{};e.rules.push(o)}}return 0==e.rules.length?{}:e}(b)},d.prototype.setRules=function(b){this.clear();var c=this.$el,d=this;!function b(c,e){var f=d.addGroup(e,!1),g=f.find(">dd>ul"),h=f.find(">dt input[name$=_cond]");c.condition||(c.condition="AND"),h.filter("[value=AND]").prop("checked","AND"==c.condition.toUpperCase()),h.filter("[value=OR]").prop("checked","OR"==c.condition.toUpperCase()),h.trigger("change"),a.each(c.rules,function(c,e){if(e.rules&&e.rules.length>0)b(e,g);else{e.id||a.error("Missing rule field id"),e.value||(e.value=""),e.operator||(e.operator="equal");var f=d.addRule(g),h=d.getFilterById(e.id),i=f.find(".rule-value-container");if(f.find(".rule-filter-container select[name$=_filter]").val(e.id).trigger("change"),f.find(".rule-operator-container select[name$=_operator]").val(e.operator).trigger("change"),"page_filter"==h.plugin){var j=0;a.each(h.plugin_config.pages,function(b,c){a.each(c,function(a,b){b.page_answer_id==e.value&&(j=b.page_code)})}),j>0&&f.find(".rule-page-container select").val(j).trigger("change")}switch(h.input){case"radio":i.find('input[name$=_value][value="'+e.value+'"]').prop("checked",!0).trigger("change");break;case"checkbox":a.isArray(e.value)||(e.value=[e.value]),a.each(e.value,function(a,b){i.find('input[name$=_value][value="'+b+'"]').prop("checked",!0).trigger("change")});break;case"select":i.find("select[name$=_value]").val(e.value).trigger("change");break;case"text":default:i.find("input[name$=_value]").val(e.value).trigger("change")}h.onAfterSetValue&&h.onAfterSetValue.call(this,f,e.value,h,e.operator)}})}(b,c)},d.prototype.checkFilters=function(){var d=[];a.each(this.filters,function(e,f){switch(f.id||a.error("Missing filter id: "+e),d.indexOf(f.id)!=-1&&a.error("Filter already defined: "+f.id),d.push(f.id),f.type||a.error("Missing filter type: "+f.id),b.indexOf(f.type)==-1&&a.error("Invalid type: "+f.type),f.input?c.indexOf(f.input)==-1&&a.error("Invalid input: "+f.input):f.input="text",f.field||(f.field=f.id),f.label||(f.label=f.field),f.type){case"string":f.internalType="string";break;case"integer":case"double":f.internalType="number";break;case"date":case"time":case"datetime":f.internalType="datetime"}switch(f.input){case"radio":case"checkbox":(!f.values||f.values.length<1)&&a.error("Missing values for filter: "+f.id)}})},d.prototype.addGroup=function(a,b){b=null==b||b;var c=this.nextGroupId();a.append(this.getGroupTemplate(c));var d=a.find("#"+c);return this.settings.onAfterAddGroup&&this.settings.onAfterAddGroup.call(this,d),b&&this.addRule(d.find(">dd>ul")),d},d.prototype.addRule=function(a){var b=this.nextRuleId();a.append(this.getRuleTemplate(b));var c=a.find("#"+b);return this.settings.onAfterAddRule&&this.settings.onAfterAddRule.call(this,c),c},d.prototype.createRuleOperators=function(a,b){var d=(a.find(".rule-operator-container").empty(),a.attr("id"));if("-1"!=b){var e=this.getOperators(b),f=this.getRuleOperatorSelect(d,e);a.find(".rule-operator-container").html(f)}},d.prototype.createPageDropDown=function(b,c){if("-1"!=c){var d=b.find(".rule-page-container").empty(),e=b.attr("id"),f=this.getFilterById(c),g=this.getOperator(this.getRuleOperator(b));g.accept_values&&(d.html(a('<select name="'+e+'_value"></select>')).show(),this.populatePagesAnswered(b,f))}},d.prototype.createRuleInput=function(a,b){if("-1"!=b){var c=a.find(".rule-value-container").empty(),d=a.attr("id"),e=this.getOperator(this.getRuleOperator(a));if(e.accept_values){var f=this.getFilterById(b),g=this.getRuleInput(d,f);c.html(g).show(),f.onAfterCreateRuleInput&&f.onAfterCreateRuleInput.call(this,a,f),f.plugin&&(a.find(".rule-page-container").show(),a.find(".rule-operator-container").hide(),a.find(".rule-value-container").hide(),this.populatePagesAnswered(a,f))}}},d.prototype.populatePagesAnswered=function(b,c){var d=b.find(".rule-page-container"),e="";a.each(c.plugin_config.pages,function(a,b){e+='<option value="'+a+'">'+c.plugin_config.pages_index[a]+": "+b[0].page_name+"</option> "}),d.find("select").html(e),this.filterPageAnswers(b,c,d.find("option:selected").val())},d.prototype.filterPageAnswers=function(b,c,d){var e=b.find(".rule-value-container"),f={};if("undefined"!=typeof c.plugin_config.pages[d]){a.each(c.plugin_config.pages[d],function(a,b){f[b.page_answer_id]=b.page_answer_text});var g="";f&&a.each(f,function(a,b){g+='<option value="'+a+'"> '+b+"</option> "}),e.find("select").html(g),e.show()}},d.prototype.updateRuleOperator=function(a,b){var c=a.find(".rule-value-container"),d=this.getFilterById(this.getRuleFilter(a)),e=this.getOperator(b);e.accept_values?(c.show(),c.is(":empty")&&(d.plugin&&"page_filter"==d.plugin&&this.createPageDropDown(a,d),this.createRuleInput(a,d))):c.hide(),d.onAfterChangeOperator&&d.onAfterChangeOperator.call(this,a,d,e.type)},d.prototype.validateValue=function(a,b){var c=b.validation||{};if(c.callback)return c.callback.call(this,a,b);switch(b.input){case"radio":if(void 0==a)return"radio_empty";break;case"checkbox":if(0==a.length)return"checkbox_empty";break;case"select":if(b.multiple){if(0==a.length)return"select_empty"}else if(void 0==a)return"select_empty";break;case"text":default:switch(b.internalType){case"string":if(void 0!=c.min){if(a.length<c.min)return"string_exceed_min_length"}else if(0==a.length)return"string_empty";if(void 0!=c.max&&a.length>c.max)return"string_exceed_max_length";if(c.format&&!c.format.test(a))return"string_invalid_format";break;case"number":if(isNaN(a))return"number_nan";if("integer"==b.type){if(parseInt(a)!=a)return"number_not_integer"}else if(parseFloat(a)!=a)return"number_not_double";if(void 0!=c.min&&a<c.min)return"number_exceed_min";if(void 0!=c.max&&a>c.max)return"number_exceed_max";if(c.step){var d=a/c.step;if(parseInt(d)!=d)return"number_wrong_step"}break;case"datetime":if(window.moment&&c.format){var e=moment(a,c.format);if(!e.isValid())return"datetime_invalid";if(c.min&&e<moment(c.min,c.format))return"datetime_exceed_min";if(c.max&&e>moment(c.max,c.format))return"datetime_exceed_max"}}}return!0},d.prototype.markRuleAsError=function(a,b){b?a.addClass("has-error"):a.removeClass("has-error")},d.prototype.triggerValidationError=function(a,b,c,d,e){b.onValidationError&&b.onValidationError.call(this,e,a,d,b,c),this.settings.onValidationError&&this.settings.onValidationError.call(this,e,a,d,b,c);var f=jQuery.Event("validationError.queryBuilder",{error:a,filter:b,operator:c,value:d,targetRule:e[0],builder:this});this.$el.trigger(f)},d.prototype.nextGroupId=function(){var a=this.$el_id+"_group_"+this.status.group_id;return this.status.group_id++,a},d.prototype.nextRuleId=function(){var a=this.$el_id+"_rule_"+this.status.rule_id;return this.status.rule_id++,a},d.prototype.getOperators=function(a){"string"==typeof a&&(a=this.getFilterById(a));for(var b=[],c=0,d=this.operators.length;c<d;c++)this.operators[c].apply_to.indexOf(a.internalType)!=-1&&(a.operators&&a.operators.indexOf(this.operators[c].type)==-1||b.push({type:this.operators[c].type,label:this.lang["operator_"+this.operators[c].type]}));return b},d.prototype.getFilterById=function(a){for(var b=0,c=this.filters.length;b<c;b++)if(this.filters[b].id==a)return this.filters[b];throw"Undefined filter: "+a},d.prototype.getOperator=function(a){for(var b=0,c=this.operators.length;b<c;b++)if(this.operators[b].type==a)return this.operators[b];throw"Undefined operator: "+a},d.prototype.getRuleFilter=function(a){return a.find(".rule-filter-container select[name$=_filter]").val()},d.prototype.getRuleOperator=function(a){return a.find(".rule-operator-container select[name$=_operator]").val()},d.prototype.getRuleValue=function(b,c){c=c||this.getFilterByType(this.getRulefilter(b));var d,e=b.find(".rule-value-container");switch(c.input){case"radio":d=e.find("input[name$=_value]:checked").val();break;case"checkbox":d=[],e.find("input[name$=_value]:checked").each(function(){d.push(a(this).val())});break;case"select":c.multiple?(d=[],e.find("select[name$=_value] option:selected").each(function(){d.push(a(this).val())})):d=e.find("select[name$=_value] option:selected").val();break;case"text":default:d=e.find("input[name$=_value]").val()}return d},d.prototype.getGroupTemplate=function(a){return"<dl id="+a+' class="rules-group-container">   <dt class="rules-group-header">     <div class="btn-group">       <label class="btn btn-mini btn-xs btn-primary active"><input type="radio" name="'+a+'_cond" value="AND" checked> '+this.lang.and_condition+'</label>       <label class="btn btn-mini btn-xs btn-primary"><input type="radio" name="'+a+'_cond" value="OR"> '+this.lang.or_condition+'</label>     </div>     <div class="btn-group pull-right">       <button type="button" class="btn btn-mini btn-xs btn-success" data-add="rule"><i class="glyphicon glyphicon-plus"></i> '+this.lang.add_rule+'</button>       <button type="button" class="btn btn-mini btn-xs btn-success" data-add="group"><i class="glyphicon glyphicon-plus-sign"></i> '+this.lang.add_group+'</button>       <button type="button" class="btn btn-mini btn-xs btn-danger" data-delete="group"><i class="glyphicon glyphicon-remove"></i> '+this.lang.delete_group+"</button>     </div>   </dt>   <dd class=rules-group-body>     <ul class=rules-list></ul>   </dd> </dl>"},d.prototype.getRuleTemplate=function(a){return"<li id="+a+' class="rule-container">   <div class="rule-header">     <div class="btn-group pull-right">       <button type="button" class="btn btn-mini btn-xs btn-danger" data-delete="rule"><i class="glyphicon glyphicon-remove"></i> '+this.lang.delete_rule+'</button>     </div>   </div>   <div class="rule-filter-container">'+this.getRuleFilterSelect(a)+'</div>   <div class="rule-operator-container"></div>   <div class="rule-page-container"></div>   <div class="rule-value-container"></div> </li>'},d.prototype.getRuleFilterSelect=function(b){var c='<select name="'+b+'_filter">';return c+='<option value="-1">'+this.lang.filter_select_placeholder+"</option>",a.each(this.filters,function(a,b){c+='<option value="'+b.id+'">'+b.label+"</option>"}),c+="</select>"},d.prototype.getRuleOperatorSelect=function(a,b){for(var c='<select name="'+a+'_operator">',d=0,e=b.length;d<e;d++)c+='<option value="'+b[d].type+'">'+b[d].label+"</option>";return c+="</select>"},d.prototype.getRuleInput=function(b,c){var d=c.validation||{},e="";switch(c.input){case"radio":var f=c.vertical?" class=block":"";a.each(c.values,function(a,c){e+="<label"+f+'><input type="radio" name="'+b+'_value" value="'+a+'"> '+c+"</label> "});break;case"checkbox":var f=c.vertical?" class=block":"";a.each(c.values,function(a,c){e+="<label"+f+'><input type="checkbox" name="'+b+'_value" value="'+a+'"> '+c+"</label> "});break;case"select":e+='<select name="'+b+'_value"'+(c.multiple?" multiple":"")+">",c.values&&a.each(c.values,function(a,b){e+='<option value="'+a+'"> '+b+"</option> "}),e+="</select>";break;case"text":default:switch(c.internalType){case"number":e+='<input type="number" name="'+b+'_value"',d.step&&(e+=' step="'+d.step+'"'),d.min&&(e+=' min="'+d.min+'"'),d.max&&(e+=' max="'+d.max+'"'),c.placeholder&&(e+=' placeholder="'+c.placeholder+'"'),e+=">";break;case"datetime":case"text":default:e+='<input type="text" name="'+b+'_value"',c.placeholder&&(e+=' placeholder="'+c.placeholder+'"'),e+=">"}}return e},a.fn.queryBuilder=function(b){this.length>1&&a.error("Unable to initialize on multiple target");var c=this.data("queryBuilder"),e="object"==typeof b&&b||{};return c||"destroy"!=b?(c||this.data("queryBuilder",new d(this,e)),"string"==typeof b?c[b].apply(c,Array.prototype.slice.call(arguments,1)):this):this}}(jQuery);
