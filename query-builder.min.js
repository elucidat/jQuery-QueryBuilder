!function(e){"use strict";var t=["string","integer","double","date","time","datetime"],r=["text","radio","checkbox","select"],i=function(t,r){var a=this;this.$el=t,this.settings=e.extend(!0,{},i.DEFAULTS,r),this.filters=this.settings.filters,this.lang=this.settings.lang,this.operators=this.settings.operators,this.status={group_id:0,rule_id:0,generatedId:!1},this.$el.attr("id")||(this.$el.attr("id","qb_"+Math.floor(99999*Math.random())),this.status.generatedId=!0),this.$el_id=this.$el.attr("id"),(!this.filters||this.filters.length<1)&&e.error("Missing filters list"),this.checkFilters(),this.$el.on("change.queryBuilder",".rules-group-header input[name$=_cond]",function(){var t=e(this);t.is(":checked")&&(t.parent().addClass("active"),t.parent().siblings().removeClass("active"))}),this.$el.on("change.queryBuilder",".rule-filter-container select[name$=_filter]",function(){var t=e(this),r=t.closest("li"),i=a.getFilterById(a.getRuleFilter(r));a.createRuleOperators(r,t.val()),"page_filter"==i.plugin&&a.createPageDropDown(r,t.val()),a.createRuleInput(r,t.val())}),this.$el.on("change.queryBuilder",".rule-operator-container select[name$=_operator]",function(){var t=e(this),r=t.closest("li");a.updateRuleOperator(r,t.val())}),this.$el.on("change.queryBuilder",".rule-page-container select",function(){var t=e(this),r=t.closest("li"),i=a.getFilterById(a.getRuleFilter(r));null!=t.val()&&a.filterPageAnswers(r,i,t.val())}),this.$el.on("click.queryBuilder","[data-add=rule]",function(){var t=e(this),r=t.closest("dl").find(">dd>ul");a.addRule(r)}),this.$el.on("click.queryBuilder","[data-add=group]",function(){var t=e(this),r=t.closest("dl").find(">dd>ul");a.addGroup(r)}),this.$el.on("click.queryBuilder","[data-delete=rule]",function(){var t=e(this),r=t.closest("li");r.remove()}),this.$el.on("click.queryBuilder","[data-delete=group]",function(){var t=e(this),r=t.closest("dl");r.remove()}),this.$el.addClass("query-builder"),this.addGroup(this.$el)};i.DEFAULTS={onValidationError:null,onAfterAddGroup:null,onAfterAddRule:null,filters:[],lang:{add_rule:"Add rule",add_group:"Add group",delete_rule:"Delete",delete_group:"Delete",and_condition:"AND",or_condition:"OR",filter_select_placeholder:"------",operator_equal:"equal",operator_not_equal:"not equal",operator_in:"in",operator_not_in:"not in",operator_less:"less",operator_less_or_equal:"less or equal",operator_greater:"greater",operator_greater_or_equal:"greater or equal",operator_begins_with:"begins with",operator_not_begins_with:"doesn't begin with",operator_contains:"contains",operator_not_contains:"doesn't contain",operator_ends_with:"ends with",operator_not_ends_with:"doesn't end with",operator_is_empty:"is empty",operator_is_not_empty:"is not empty",operator_is_null:"is null",operator_is_not_null:"is not null"},operators:[{type:"equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"not_equal",accept_values:!0,apply_to:["string","number","datetime"]},{type:"in",accept_values:!0,apply_to:["string","number","datetime"]},{type:"not_in",accept_values:!0,apply_to:["string","number","datetime"]},{type:"less",accept_values:!0,apply_to:["number","datetime"]},{type:"less_or_equal",accept_values:!0,apply_to:["number","datetime"]},{type:"greater",accept_values:!0,apply_to:["number","datetime"]},{type:"greater_or_equal",accept_values:!0,apply_to:["number","datetime"]},{type:"begins_with",accept_values:!0,apply_to:["string"]},{type:"not_begins_with",accept_values:!0,apply_to:["string"]},{type:"contains",accept_values:!0,apply_to:["string"]},{type:"not_contains",accept_values:!0,apply_to:["string"]},{type:"ends_with",accept_values:!0,apply_to:["string"]},{type:"not_ends_with",accept_values:!0,apply_to:["string"]},{type:"is_empty",accept_values:!1,apply_to:["string"]},{type:"is_not_empty",accept_values:!1,apply_to:["string"]},{type:"is_null",accept_values:!1,apply_to:["string","number","datetime"]},{type:"is_not_null",accept_values:!1,apply_to:["string","number","datetime"]}]},window.QueryBuilder={setDefaults:function(t){e.extend(!0,i.DEFAULTS,t)}},i.prototype.destroy=function(){this.status.generatedId&&this.$el.removeAttr("id"),this.$el.empty().off("click.queryBuilder change.queryBuilder").removeClass("query-builder").removeData("queryBuilder")},i.prototype.reset=function(){this.status.group_id=1,this.status.rule_id=0,this.addRule(this.$el.find(">dl>dd>ul").empty())},i.prototype.clear=function(){this.status.group_id=0,this.status.rule_id=0,this.$el.empty()},i.prototype.getRules=function(){this.markRuleAsError(this.$el.find("li"),!1);var t=this.$el.find(">dl"),r=this;return function i(t){var a={},n=t.find(">dd>ul>*");a.condition=t.find(">dt input[name$=_cond]:checked").val(),a.rules=[];for(var l=0,o=n.length;o>l;l++){var s=n.eq(l);if(s.hasClass("rule-container")){var u=r.getRuleFilter(s);if("-1"==u)continue;var p=r.getFilterById(u),c=r.getOperator(r.getRuleOperator(s)),d=null;if(c.accept_values){d=r.getRuleValue(s,p);var h=r.validateValue(d,p);if(h!==!0)return r.markRuleAsError(s,!0),r.triggerValidationError(h,p,c,d,s),{};p.valueParser&&(d=p.valueParser.call(this,d,p,c))}var g={id:p.id,field:p.field,type:p.type,input:p.input,operator:c.type,value:d};a.rules.push(g)}else{var g=i(s);if(e.isEmptyObject(g))return{};a.rules.push(g)}}return 0==a.rules.length?{}:a}(t)},i.prototype.setRules=function(t){this.clear();var r=this.$el,i=this;!function a(t,r){var n=i.addGroup(r,!1),l=n.find(">dd>ul"),o=n.find(">dt input[name$=_cond]");t.condition||(t.condition="AND"),o.filter("[value=AND]").prop("checked","AND"==t.condition.toUpperCase()),o.filter("[value=OR]").prop("checked","OR"==t.condition.toUpperCase()),o.trigger("change"),e.each(t.rules,function(t,r){if(r.rules&&r.rules.length>0)a(r,l);else{r.id||e.error("Missing rule field id"),r.value||(r.value=""),r.operator||(r.operator="equal");var n=i.addRule(l),o=i.getFilterById(r.id),s=n.find(".rule-value-container");if(n.find(".rule-filter-container select[name$=_filter]").val(r.id).trigger("change"),n.find(".rule-operator-container select[name$=_operator]").val(r.operator).trigger("change"),"page_filter"==o.plugin){var u=0;e.each(o.plugin_config.pages,function(t,i){e.each(i,function(e,t){t.page_answer_id==r.value&&(u=t.page_id)})}),u>0&&n.find(".rule-page-container select").val(u).trigger("change")}switch(o.input){case"radio":s.find('input[name$=_value][value="'+r.value+'"]').prop("checked",!0).trigger("change");break;case"checkbox":e.isArray(r.value)||(r.value=[r.value]),e.each(r.value,function(e,t){s.find('input[name$=_value][value="'+t+'"]').prop("checked",!0).trigger("change")});break;case"select":s.find("select[name$=_value]").val(r.value).trigger("change");break;case"text":default:s.find("input[name$=_value]").val(r.value).trigger("change")}o.onAfterSetValue&&o.onAfterSetValue.call(this,n,r.value,o,r.operator)}})}(t,r)},i.prototype.checkFilters=function(){var i=[];e.each(this.filters,function(a,n){switch(n.id||e.error("Missing filter id: "+a),-1!=i.indexOf(n.id)&&e.error("Filter already defined: "+n.id),i.push(n.id),n.type||e.error("Missing filter type: "+n.id),-1==t.indexOf(n.type)&&e.error("Invalid type: "+n.type),n.input?-1==r.indexOf(n.input)&&e.error("Invalid input: "+n.input):n.input="text",n.field||(n.field=n.id),n.label||(n.label=n.field),n.type){case"string":n.internalType="string";break;case"integer":case"double":n.internalType="number";break;case"date":case"time":case"datetime":n.internalType="datetime"}switch(n.input){case"radio":case"checkbox":(!n.values||n.values.length<1)&&e.error("Missing values for filter: "+n.id)}})},i.prototype.addGroup=function(e,t){t=null==t?!0:t;var r=this.nextGroupId();e.append(this.getGroupTemplate(r));var i=e.find("#"+r);return this.settings.onAfterAddGroup&&this.settings.onAfterAddGroup.call(this,i),t&&this.addRule(i.find(">dd>ul")),i},i.prototype.addRule=function(e){var t=this.nextRuleId();e.append(this.getRuleTemplate(t));var r=e.find("#"+t);return this.settings.onAfterAddRule&&this.settings.onAfterAddRule.call(this,r),r},i.prototype.createRuleOperators=function(e,t){var r=(e.find(".rule-operator-container").empty(),e.attr("id"));if("-1"!=t){var i=this.getOperators(t),a=this.getRuleOperatorSelect(r,i);e.find(".rule-operator-container").html(a)}},i.prototype.createPageDropDown=function(t,r){if("-1"!=r){var i=t.find(".rule-page-container").empty(),a=t.attr("id"),n=this.getFilterById(r),l=this.getOperator(this.getRuleOperator(t));l.accept_values&&(i.html(e('<select name="'+a+'_value"></select>')).show(),this.populatePagesAnswered(t,n))}},i.prototype.createRuleInput=function(e,t){if("-1"!=t){var r=e.find(".rule-value-container").empty(),i=e.attr("id"),a=this.getOperator(this.getRuleOperator(e));if(a.accept_values){var n=this.getFilterById(t),l=this.getRuleInput(i,n);r.html(l).show(),n.onAfterCreateRuleInput&&n.onAfterCreateRuleInput.call(this,e,n),n.plugin&&(e.find(".rule-page-container").show(),e.find(".rule-operator-container").hide(),e.find(".rule-value-container").hide(),this.populatePagesAnswered(e,n))}}},i.prototype.populatePagesAnswered=function(t,r){var i=t.find(".rule-page-container"),a="",n=1;e.each(r.plugin_config.pages,function(e,t){a+='<option value="'+e+'">'+r.plugin_config.pages_index[e]+": "+t[0].page_name+"</option> ",n++}),i.find("select").html(a),this.filterPageAnswers(t,r,i.find("option:selected").val())},i.prototype.filterPageAnswers=function(t,r,i){var a=t.find(".rule-value-container"),n={};if("undefined"!=typeof r.plugin_config.pages[i]){e.each(r.plugin_config.pages[i],function(e,t){n[t.page_answer_id]=t.page_answer_text});var l="";n&&e.each(n,function(e,t){l+='<option value="'+e+'"> '+t+"</option> "}),a.find("select").html(l),a.show()}},i.prototype.updateRuleOperator=function(e,t){var r=e.find(".rule-value-container"),i=this.getFilterById(this.getRuleFilter(e)),a=this.getOperator(t);a.accept_values?(r.show(),r.is(":empty")&&(i.plugin&&"page_filter"==i.plugin&&this.createPageDropDown(e,i),this.createRuleInput(e,i))):r.hide(),i.onAfterChangeOperator&&i.onAfterChangeOperator.call(this,e,i,a.type)},i.prototype.validateValue=function(e,t){var r=t.validation||{};if(r.callback)return r.callback.call(this,e,t);switch(t.input){case"radio":if(void 0==e)return"radio_empty";break;case"checkbox":if(0==e.length)return"checkbox_empty";break;case"select":if(t.multiple){if(0==e.length)return"select_empty"}else if(void 0==e)return"select_empty";break;case"text":default:switch(t.internalType){case"string":if(void 0!=r.min){if(e.length<r.min)return"string_exceed_min_length"}else if(0==e.length)return"string_empty";if(void 0!=r.max&&e.length>r.max)return"string_exceed_max_length";if(r.format&&!r.format.test(e))return"string_invalid_format";break;case"number":if(isNaN(e))return"number_nan";if("integer"==t.type){if(parseInt(e)!=e)return"number_not_integer"}else if(parseFloat(e)!=e)return"number_not_double";if(void 0!=r.min&&e<r.min)return"number_exceed_min";if(void 0!=r.max&&e>r.max)return"number_exceed_max";if(r.step){var i=e/r.step;if(parseInt(i)!=i)return"number_wrong_step"}break;case"datetime":if(window.moment&&r.format){var a=moment(e,r.format);if(!a.isValid())return"datetime_invalid";if(r.min&&a<moment(r.min,r.format))return"datetime_exceed_min";if(r.max&&a>moment(r.max,r.format))return"datetime_exceed_max"}}}return!0},i.prototype.markRuleAsError=function(e,t){t?e.addClass("has-error"):e.removeClass("has-error")},i.prototype.triggerValidationError=function(e,t,r,i,a){t.onValidationError&&t.onValidationError.call(this,a,e,i,t,r),this.settings.onValidationError&&this.settings.onValidationError.call(this,a,e,i,t,r);var n=jQuery.Event("validationError.queryBuilder",{error:e,filter:t,operator:r,value:i,targetRule:a[0],builder:this});this.$el.trigger(n)},i.prototype.nextGroupId=function(){var e=this.$el_id+"_group_"+this.status.group_id;return this.status.group_id++,e},i.prototype.nextRuleId=function(){var e=this.$el_id+"_rule_"+this.status.rule_id;return this.status.rule_id++,e},i.prototype.getOperators=function(e){"string"==typeof e&&(e=this.getFilterById(e));for(var t=[],r=0,i=this.operators.length;i>r;r++)-1!=this.operators[r].apply_to.indexOf(e.internalType)&&(e.operators&&-1==e.operators.indexOf(this.operators[r].type)||t.push({type:this.operators[r].type,label:this.lang["operator_"+this.operators[r].type]}));return t},i.prototype.getFilterById=function(e){for(var t=0,r=this.filters.length;r>t;t++)if(this.filters[t].id==e)return this.filters[t];throw"Undefined filter: "+e},i.prototype.getOperator=function(e){for(var t=0,r=this.operators.length;r>t;t++)if(this.operators[t].type==e)return this.operators[t];throw"Undefined operator: "+e},i.prototype.getRuleFilter=function(e){return e.find(".rule-filter-container select[name$=_filter]").val()},i.prototype.getRuleOperator=function(e){return e.find(".rule-operator-container select[name$=_operator]").val()},i.prototype.getRuleValue=function(t,r){r=r||this.getFilterByType(this.getRulefilter(t));var i,a=t.find(".rule-value-container");switch(r.input){case"radio":i=a.find("input[name$=_value]:checked").val();break;case"checkbox":i=[],a.find("input[name$=_value]:checked").each(function(){i.push(e(this).val())});break;case"select":r.multiple?(i=[],a.find("select[name$=_value] option:selected").each(function(){i.push(e(this).val())})):i=a.find("select[name$=_value] option:selected").val();break;case"text":default:i=a.find("input[name$=_value]").val()}return i},i.prototype.getGroupTemplate=function(e){return"<dl id="+e+' class="rules-group-container">   <dt class="rules-group-header">     <div class="btn-group">       <label class="btn btn-mini btn-xs btn-primary active"><input type="radio" name="'+e+'_cond" value="AND" checked> '+this.lang.and_condition+'</label>       <label class="btn btn-mini btn-xs btn-primary"><input type="radio" name="'+e+'_cond" value="OR"> '+this.lang.or_condition+'</label>     </div>     <div class="btn-group pull-right">       <button type="button" class="btn btn-mini btn-xs btn-success" data-add="rule"><i class="glyphicon glyphicon-plus"></i> '+this.lang.add_rule+'</button>       <button type="button" class="btn btn-mini btn-xs btn-success" data-add="group"><i class="glyphicon glyphicon-plus-sign"></i> '+this.lang.add_group+'</button>       <button type="button" class="btn btn-mini btn-xs btn-danger" data-delete="group"><i class="glyphicon glyphicon-remove"></i> '+this.lang.delete_group+"</button>     </div>   </dt>   <dd class=rules-group-body>     <ul class=rules-list></ul>   </dd> </dl>"},i.prototype.getRuleTemplate=function(e){return"<li id="+e+' class="rule-container">   <div class="rule-header">     <div class="btn-group pull-right">       <button type="button" class="btn btn-mini btn-xs btn-danger" data-delete="rule"><i class="glyphicon glyphicon-remove"></i> '+this.lang.delete_rule+'</button>     </div>   </div>   <div class="rule-filter-container">'+this.getRuleFilterSelect(e)+'</div>   <div class="rule-operator-container"></div>   <div class="rule-page-container"></div>   <div class="rule-value-container"></div> </li>'},i.prototype.getRuleFilterSelect=function(t){var r='<select name="'+t+'_filter">';return r+='<option value="-1">'+this.lang.filter_select_placeholder+"</option>",e.each(this.filters,function(e,t){r+='<option value="'+t.id+'">'+t.label+"</option>"}),r+="</select>"},i.prototype.getRuleOperatorSelect=function(e,t){for(var r='<select name="'+e+'_operator">',i=0,a=t.length;a>i;i++)r+='<option value="'+t[i].type+'">'+t[i].label+"</option>";return r+="</select>"},i.prototype.getRuleInput=function(t,r){var i=r.validation||{},a="";switch(r.input){case"radio":var n=r.vertical?" class=block":"";e.each(r.values,function(e,r){a+="<label"+n+'><input type="radio" name="'+t+'_value" value="'+e+'"> '+r+"</label> "});break;case"checkbox":var n=r.vertical?" class=block":"";e.each(r.values,function(e,r){a+="<label"+n+'><input type="checkbox" name="'+t+'_value" value="'+e+'"> '+r+"</label> "});break;case"select":a+='<select name="'+t+'_value"'+(r.multiple?" multiple":"")+">",r.values&&e.each(r.values,function(e,t){a+='<option value="'+e+'"> '+t+"</option> "}),a+="</select>";break;case"text":default:switch(r.internalType){case"number":a+='<input type="number" name="'+t+'_value"',i.step&&(a+=' step="'+i.step+'"'),i.min&&(a+=' min="'+i.min+'"'),i.max&&(a+=' max="'+i.max+'"'),r.placeholder&&(a+=' placeholder="'+r.placeholder+'"'),a+=">";break;case"datetime":case"text":default:a+='<input type="text" name="'+t+'_value"',r.placeholder&&(a+=' placeholder="'+r.placeholder+'"'),a+=">"}}return a},e.fn.queryBuilder=function(t){this.length>1&&e.error("Unable to initialize on multiple target");var r=this.data("queryBuilder"),a="object"==typeof t&&t||{};return r||"destroy"!=t?(r||this.data("queryBuilder",new i(this,a)),"string"==typeof t?r[t].apply(r,Array.prototype.slice.call(arguments,1)):this):this}}(jQuery);
